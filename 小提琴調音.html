<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Violin Tone Generator (G3-A7)</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .note-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }
    button {
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    button.note:hover {
      background-color: #f0f0f0;
    }
    button.active {
      background-color: #ffcccb;
      border-color: #ff6b6b;
    }
    button.root {
      background-color: #ff9999;
      border-color: #ff3333;
    }
    button#stopBtn {
      background-color: #ff6b6b;
      color: white;
      margin-left: 10px;
    }
    .controls {
      background: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .control-group {
      display: flex;
      align-items: center;
    }
    label {
      margin-right: 8px;
      font-weight: 500;
    }
    select {
      padding: 5px;
      border-radius: 4px;
    }
    .treble-clef {
      font-size: 2rem;
      text-align: center;
      margin: 10px 0;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Violin Tone Generator (G3 to A7)</h1>
  <div class="treble-clef">&#119070;</div>

  <div class="controls">
    <div class="control-group">
      <label for="scale">Scale:</label>
      <select id="scale">
        <option value="all">All Notes</option>
        <option value="major">Major</option>
        <option value="minor">Minor</option>
      </select>
    </div>

    <div class="control-group">
      <label for="root">Root:</label>
      <select id="root">
        <option value="C">C</option>
        <option value="C#">C♯/D♭</option>
        <option value="D">D</option>
        <option value="D#">D♯/E♭</option>
        <option value="E">E</option>
        <option value="F">F</option>
        <option value="F#">F♯/G♭</option>
        <option value="G">G</option>
        <option value="G#">G♯/A♭</option>
        <option value="A">A</option>
        <option value="A#">A♯/B♭</option>
        <option value="B">B</option>
      </select>
    </div>

    <div class="control-group">
      <label for="tuning">Tuning (A):</label>
      <select id="tuning">
        <option value="440">440 Hz</option>
        <option value="442">442 Hz</option>
        <option value="435">435 Hz</option>
      </select>
    </div>

    <div class="control-group">
      <button id="stopBtn">Stop Sound</button>
    </div>
  </div>

  <div class="note-grid" id="noteGrid"></div>

  <script>
    // ================== 音符數據 (擴展到A7) ==================
    const notes = [
      // G弦
      { name: 'G3', freq: 196.00, pitchClass: 'G', octave: 3 },
      { name: 'G#3', freq: 207.65, pitchClass: 'G#', octave: 3 },
      { name: 'A3', freq: 220.00, pitchClass: 'A', octave: 3 },
      { name: 'A#3', freq: 233.08, pitchClass: 'A#', octave: 3 },
      { name: 'B3', freq: 246.94, pitchClass: 'B', octave: 3 },
      
      // D弦
      { name: 'C4', freq: 261.63, pitchClass: 'C', octave: 4 },
      { name: 'C#4', freq: 277.18, pitchClass: 'C#', octave: 4 },
      { name: 'D4', freq: 293.66, pitchClass: 'D', octave: 4 },
      { name: 'D#4', freq: 311.13, pitchClass: 'D#', octave: 4 },
      { name: 'E4', freq: 329.63, pitchClass: 'E', octave: 4 },
      { name: 'F4', freq: 349.23, pitchClass: 'F', octave: 4 },
      { name: 'F#4', freq: 369.99, pitchClass: 'F#', octave: 4 },
      
      // A弦
      { name: 'G4', freq: 392.00, pitchClass: 'G', octave: 4 },
      { name: 'G#4', freq: 415.30, pitchClass: 'G#', octave: 4 },
      { name: 'A4', freq: 440.00, pitchClass: 'A', octave: 4 },
      { name: 'A#4', freq: 466.16, pitchClass: 'A#', octave: 4 },
      { name: 'B4', freq: 493.88, pitchClass: 'B', octave: 4 },
      { name: 'C5', freq: 523.25, pitchClass: 'C', octave: 5 },
      { name: 'C#5', freq: 554.37, pitchClass: 'C#', octave: 5 },
      { name: 'D5', freq: 587.33, pitchClass: 'D', octave: 5 },
      { name: 'D#5', freq: 622.25, pitchClass: 'D#', octave: 5 },
      { name: 'E5', freq: 659.25, pitchClass: 'E', octave: 5 },
      { name: 'F5', freq: 698.46, pitchClass: 'F', octave: 5 },
      { name: 'F#5', freq: 739.99, pitchClass: 'F#', octave: 5 },
      
      // E弦
      { name: 'G5', freq: 783.99, pitchClass: 'G', octave: 5 },
      { name: 'G#5', freq: 830.61, pitchClass: 'G#', octave: 5 },
      { name: 'A5', freq: 880.00, pitchClass: 'A', octave: 5 },
      { name: 'A#5', freq: 932.33, pitchClass: 'A#', octave: 5 },
      { name: 'B5', freq: 987.77, pitchClass: 'B', octave: 5 },
      { name: 'C6', freq: 1046.50, pitchClass: 'C', octave: 6 },
      { name: 'C#6', freq: 1108.73, pitchClass: 'C#', octave: 6 },
      { name: 'D6', freq: 1174.66, pitchClass: 'D', octave: 6 },
      { name: 'D#6', freq: 1244.51, pitchClass: 'D#', octave: 6 },
      { name: 'E6', freq: 1318.51, pitchClass: 'E', octave: 6 },
      { name: 'F6', freq: 1396.91, pitchClass: 'F', octave: 6 },
      { name: 'F#6', freq: 1479.98, pitchClass: 'F#', octave: 6 },
      { name: 'G6', freq: 1567.98, pitchClass: 'G', octave: 6 },
      { name: 'G#6', freq: 1661.22, pitchClass: 'G#', octave: 6 },
      { name: 'A6', freq: 1760.00, pitchClass: 'A', octave: 6 },
      { name: 'A#6', freq: 1864.66, pitchClass: 'A#', octave: 6 },
      { name: 'B6', freq: 1975.53, pitchClass: 'B', octave: 6 },
      { name: 'C7', freq: 2093.00, pitchClass: 'C', octave: 7 },
      { name: 'C#7', freq: 2217.46, pitchClass: 'C#', octave: 7 },
      { name: 'D7', freq: 2349.32, pitchClass: 'D', octave: 7 },
      { name: 'D#7', freq: 2489.02, pitchClass: 'D#', octave: 7 },
      { name: 'E7', freq: 2637.02, pitchClass: 'E', octave: 7 },
      { name: 'F7', freq: 2793.83, pitchClass: 'F', octave: 7 },
      { name: 'F#7', freq: 2959.96, pitchClass: 'F#', octave: 7 },
      { name: 'G7', freq: 3135.96, pitchClass: 'G', octave: 7 },
      { name: 'G#7', freq: 3322.44, pitchClass: 'G#', octave: 7 },
      { name: 'A7', freq: 3520.00, pitchClass: 'A', octave: 7 }
    ];

    // ================== 音階模式定義 ==================
    const scalePatterns = {
      major: [0, 2, 4, 5, 7, 9, 11], // 大調音階 (全全半全全全半)
      minor: [0, 2, 3, 5, 7, 8, 10]  // 小調音階 (全半全全半全全)
    };

    // ================== 音頻控制 ==================
    let audioContext;
    let oscillators = [];
    let currentTuning = 440;

    // 初始化所有音符按鈕
    function initNotes() {
      const grid = document.getElementById('noteGrid');
      grid.innerHTML = '';

      notes.forEach(note => {
        const btn = document.createElement('button');
        btn.className = 'note';
        btn.textContent = note.name.replace('#', '♯').replace('b', '♭');
        btn.dataset.pitchClass = note.pitchClass;
        btn.dataset.octave = note.octave;
        btn.addEventListener('click', () => playNote(note.freq));
        grid.appendChild(btn);
      });

      updateScaleHighlight();
    }

    // 播放音符 (自動處理音頻上下文初始化)
    function playNote(baseFreq) {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      stopSound(); // 停止先前聲音

      const freq = baseFreq * (currentTuning / 440);
      const osc = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      osc.type = 'sine';
      osc.frequency.value = freq;
      gainNode.gain.value = 0.7; // 稍低音量避免爆音

      osc.connect(gainNode).connect(audioContext.destination);
      osc.start();
      oscillators.push(osc);
    }

    // 停止所有聲音
    function stopSound() {
      oscillators.forEach(osc => {
        try {
          osc.stop();
          osc.disconnect();
        } catch(e) {
          console.warn("Error stopping oscillator:", e);
        }
      });
      oscillators = [];
    }

    // 更新音階高亮顯示
    function updateScaleHighlight() {
      const scaleType = document.getElementById('scale').value;
      const rootNote = document.getElementById('root').value.split('/')[0]; // 處理 C#/Db 情況

      // 半音階順序 (必須與 pitchClass 一致)
      const semitones = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

      document.querySelectorAll('.note').forEach(btn => {
        btn.classList.remove('active', 'root');

        if (scaleType === 'all') return;

        const pitchClass = btn.dataset.pitchClass;
        const rootIndex = semitones.indexOf(rootNote);
        const noteIndex = semitones.indexOf(pitchClass);
        const relativePosition = (noteIndex - rootIndex + 12) % 12;

        if (scalePatterns[scaleType].includes(relativePosition)) {
          btn.classList.add('active');
        }
        if (relativePosition === 0) {
          btn.classList.add('root');
        }
      });
    }

    // ================== 事件監聽 ==================
    document.getElementById('scale').addEventListener('change', updateScaleHighlight);
    document.getElementById('root').addEventListener('change', updateScaleHighlight);
    document.getElementById('tuning').addEventListener('change', function() {
      currentTuning = parseFloat(this.value);
    });
    document.getElementById('stopBtn').addEventListener('click', stopSound);

    // 頁面載入時初始化
    window.addEventListener('load', initNotes);
  </script>
</body>
</html>